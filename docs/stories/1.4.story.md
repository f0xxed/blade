# Story 1.4: Implement CI/CD Pipeline with GitHub Actions

## Status

**Draft**

---

## Story

**As a** developer,
**I want** automated build and deployment on every push to main branch,
**so that** changes go live quickly without manual deployment steps.

---

## Acceptance Criteria

1. GitHub repository created and local project pushed to remote
2. GitHub Actions workflow file created (`.github/workflows/deploy.yml`)
3. Workflow triggers on push to `main` branch
4. Workflow installs dependencies (`npm install`) and runs build (`npm run build`)
5. AWS credentials securely stored in GitHub Secrets (AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY)
6. Workflow syncs `/dist` directory to S3 bucket using AWS CLI or GitHub Actions S3 sync
7. Workflow invalidates CloudFront cache after deployment to ensure fresh content (`aws cloudfront create-invalidation`)
8. Build failures prevent deployment - workflow fails if build step errors
9. Deployment status visible in GitHub Actions tab with success/failure indicators
10. Test deployment: Push commit to `main` and verify automated deployment completes successfully and site updates

---

## Tasks / Subtasks

- [ ] **Task 1: Create GitHub Repository and Push Local Code** (AC: 1)
  - [ ] Create new repository on GitHub (public or private as per project requirements)
  - [ ] Initialize local git repository if not already done (`git init`)
  - [ ] Add GitHub remote origin (`git remote add origin <repo-url>`)
  - [ ] Create `.gitignore` file with proper exclusions (node_modules, .env, dist, etc.)
  - [ ] Commit all current project files
  - [ ] Push to `main` branch (`git push -u origin main`)
  - [ ] Verify all project files visible in GitHub repository

- [ ] **Task 2: Create GitHub Actions Workflow Directory and File** (AC: 2)
  - [ ] Create `.github/workflows/` directory in project root
  - [ ] Create `deploy.yml` workflow file in `.github/workflows/`
  - [ ] Configure workflow name: "Deploy to AWS"
  - [ ] Configure workflow trigger: on push to `main` branch and `workflow_dispatch` for manual triggers
  - [ ] Reference deployment-architecture.md for complete workflow structure
  - [ ] Commit and push workflow file to repository

- [ ] **Task 3: Configure Frontend Build and Deployment Job** (AC: 3, 4, 6, 7)
  - [ ] Define `deploy-frontend` job in workflow
  - [ ] Set runner: `ubuntu-latest`
  - [ ] Add checkout action (`actions/checkout@v4`)
  - [ ] Add Node.js setup action (`actions/setup-node@v4`) with version 20 and npm cache
  - [ ] Add install dependencies step: `npm ci`
  - [ ] Add build step: `npm run build`
  - [ ] Configure build environment variables from GitHub Secrets:
    - [ ] VITE_API_BASE_URL (future API endpoint)
    - [ ] VITE_GA4_MEASUREMENT_ID (Google Analytics)
    - [ ] VITE_RECAPTCHA_SITE_KEY (reCAPTCHA)
    - [ ] VITE_INSTAGRAM_BUSINESS_ACCOUNT_ID (Instagram API)
  - [ ] Add AWS credentials configuration step using `aws-actions/configure-aws-credentials@v4`
  - [ ] Add S3 sync step with optimized cache headers:
    - [ ] Sync dist/ to S3 bucket with `--cache-control "public, max-age=31536000, immutable"` for assets
    - [ ] Exclude index.html from cache (use `--exclude "index.html"`)
    - [ ] Separately upload index.html with `--cache-control "no-cache, no-store, must-revalidate"`
    - [ ] Use `--delete` flag to remove old files from S3
  - [ ] Add CloudFront cache invalidation step:
    - [ ] Run `aws cloudfront create-invalidation --distribution-id <CLOUDFRONT_DISTRIBUTION_ID> --paths "/*"`
  - [ ] Verify job structure matches architecture specification [Source: architecture/deployment-architecture.md#CI/CD Pipeline]

- [ ] **Task 4: Configure GitHub Secrets for AWS and Environment Variables** (AC: 5)
  - [ ] Navigate to GitHub repository Settings → Secrets and variables → Actions
  - [ ] Add AWS credentials secrets:
    - [ ] AWS_ACCESS_KEY_ID (from AWS IAM user created in Story 1.2 or new deployment user)
    - [ ] AWS_SECRET_ACCESS_KEY (from AWS IAM user)
  - [ ] Add AWS infrastructure secrets:
    - [ ] S3_BUCKET (value: `bladeandbarrel-site` from Story 1.2)
    - [ ] CLOUDFRONT_DISTRIBUTION_ID (value: `EJNJPQN7X1JDD` from Story 1.2)
  - [ ] Add frontend environment variable secrets (placeholders for future stories):
    - [ ] VITE_API_BASE_URL (placeholder: `https://api.bladeandbarrel.com`)
    - [ ] VITE_GA4_MEASUREMENT_ID (placeholder: empty or future GA4 ID)
    - [ ] VITE_RECAPTCHA_SITE_KEY (placeholder: empty or future reCAPTCHA key)
    - [ ] VITE_INSTAGRAM_BUSINESS_ACCOUNT_ID (placeholder: empty or future Instagram ID)
  - [ ] Document all secrets in deployment guide or README.md
  - [ ] Verify IAM user has required permissions: s3:PutObject, s3:DeleteObject, cloudfront:CreateInvalidation

- [ ] **Task 5: Add Build Failure Handling and Error Reporting** (AC: 8, 9)
  - [ ] Ensure each step in workflow uses proper error handling (GitHub Actions fails on non-zero exit codes by default)
  - [ ] Verify build step will fail workflow if `npm run build` returns error
  - [ ] Add workflow status badges to README.md for visibility:
    - [ ] Add deploy workflow badge: `![Deploy](https://github.com/{org}/{repo}/workflows/Deploy%20to%20AWS/badge.svg)`
  - [ ] Test failure scenario by intentionally breaking build (e.g., TypeScript error) and verify workflow fails
  - [ ] Verify GitHub Actions tab shows clear success/failure status with logs
  - [ ] Ensure CloudFront invalidation only runs if S3 sync succeeds (proper step dependency)

- [ ] **Task 6: Test Deployment Pipeline End-to-End** (AC: 10)
  - [ ] Make a minor change to frontend code (e.g., update tagline in App.tsx or add comment)
  - [ ] Commit and push changes to `main` branch
  - [ ] Monitor GitHub Actions workflow execution in real-time
  - [ ] Verify all workflow steps complete successfully:
    - [ ] Checkout code ✓
    - [ ] Setup Node.js ✓
    - [ ] Install dependencies ✓
    - [ ] Build frontend ✓
    - [ ] Configure AWS credentials ✓
    - [ ] Sync to S3 ✓
    - [ ] Invalidate CloudFront cache ✓
  - [ ] Wait for CloudFront invalidation to complete (typically 1-5 minutes)
  - [ ] Visit https://bladeandbarrel.com and verify changes are live
  - [ ] Test cache headers using browser DevTools Network tab:
    - [ ] Verify assets (JS/CSS) have `max-age=31536000` cache header
    - [ ] Verify index.html has `no-cache` header
  - [ ] Document successful deployment in story completion notes

- [ ] **Task 7: Update Project Documentation** (AC: 1, 2)
  - [ ] Update README.md with deployment information:
    - [ ] Add "Deployment" section explaining GitHub Actions workflow
    - [ ] Add instructions for configuring GitHub Secrets
    - [ ] Add workflow status badge at top of README
    - [ ] Document manual deployment trigger via `workflow_dispatch`
  - [ ] Create or update `docs/deployment-guide.md` with:
    - [ ] Step-by-step GitHub repository setup
    - [ ] GitHub Secrets configuration checklist
    - [ ] Workflow file explanation
    - [ ] Troubleshooting common CI/CD issues
    - [ ] Rollback procedure using S3 versioning
  - [ ] Update `infrastructure/aws-resources.md` with IAM user permissions required for CI/CD
  - [ ] Commit and push documentation updates

---

## Dev Notes

### Previous Story Insights

[Source: Story 1.3 Dev Agent Record]

Story 1.3 successfully configured custom domain infrastructure with the following production resources ready for CI/CD integration:

- **CloudFront Distribution ID**: `EJNJPQN7X1JDD`
- **Custom Domain**: `https://bladeandbarrel.com` (primary production URL)
- **S3 Bucket**: `bladeandbarrel-site` (us-east-1)
- **SSL Certificate**: ACM certificate validated and associated with CloudFront
- **Infrastructure Directory**: `/infrastructure` directory with reference configuration files
- **Current Deployment Method**: Manual AWS CLI commands (to be replaced with automated CI/CD)

The infrastructure is fully operational and ready to accept automated deployments via GitHub Actions. This story will replace manual deployment steps with a fully automated CI/CD pipeline.

### CI/CD Pipeline Architecture

[Source: architecture/deployment-architecture.md#CI/CD Pipeline]

**CI/CD Platform:**
- **Platform**: GitHub Actions
- **Cost**: Free for public repositories
- **Workflow Location**: `.github/workflows/deploy.yml`
- **Trigger**: Push to `main` branch or manual `workflow_dispatch`

**Workflow Structure:**

The complete workflow YAML is provided in the architecture document. Key components:

1. **Frontend Deployment Job** (`deploy-frontend`):
   - Runs on `ubuntu-latest`
   - Checks out code
   - Sets up Node.js 20 with npm cache
   - Installs dependencies: `npm ci`
   - Builds frontend: `npm run build`
   - Configures AWS credentials from GitHub Secrets
   - Syncs dist/ to S3 with optimized cache headers
   - Invalidates CloudFront cache for fresh content delivery

2. **Lambda Deployment Job** (`deploy-lambda`, future):
   - Deferred to Epic 2 when backend Lambda functions are implemented
   - Will deploy contact-form and instagram-proxy Lambda functions
   - Current story focuses on frontend deployment only

**Environment Variables in Build:**

Frontend build requires environment variables injected at build time:
- `VITE_API_BASE_URL`: Backend API endpoint (future)
- `VITE_GA4_MEASUREMENT_ID`: Google Analytics 4 tracking ID (future)
- `VITE_RECAPTCHA_SITE_KEY`: reCAPTCHA site key (future)
- `VITE_INSTAGRAM_BUSINESS_ACCOUNT_ID`: Instagram Business Account ID (future)

These are configured as GitHub Secrets and passed to build step via `env:` block.

### AWS Credentials and Permissions

[Source: architecture/deployment-architecture.md#Deployment Strategy]

**Required AWS IAM Permissions:**

The GitHub Actions workflow requires an AWS IAM user with the following permissions:

1. **S3 Permissions** (for static site deployment):
   - `s3:PutObject` - Upload files to S3 bucket
   - `s3:DeleteObject` - Remove old files during sync
   - `s3:ListBucket` - List bucket contents for sync

2. **CloudFront Permissions** (for cache invalidation):
   - `cloudfront:CreateInvalidation` - Invalidate cached content
   - `cloudfront:GetInvalidation` - Check invalidation status

**IAM User Setup:**
- Create dedicated IAM user for GitHub Actions (e.g., `github-actions-deploy`)
- Attach custom policy with minimal required permissions
- Generate access key ID and secret access key
- Store credentials in GitHub Secrets (never commit to repository)

### S3 Sync and Cache Optimization

[Source: architecture/deployment-architecture.md#CI/CD Pipeline]

**S3 Sync Strategy:**

Two-step sync process for optimal caching:

1. **Sync all assets with long-term caching:**
   ```bash
   aws s3 sync dist/ s3://$S3_BUCKET --delete \
     --cache-control "public, max-age=31536000, immutable" \
     --exclude "index.html"
   ```
   - `--delete` removes old files from S3 (clean deployments)
   - `max-age=31536000` = 1 year cache for hashed assets (Vite generates unique filenames)
   - `immutable` tells browsers asset will never change
   - `--exclude "index.html"` prevents index.html from getting cached

2. **Upload index.html with no caching:**
   ```bash
   aws s3 cp dist/index.html s3://$S3_BUCKET/index.html \
     --cache-control "no-cache, no-store, must-revalidate"
   ```
   - Ensures browsers always fetch latest index.html
   - Index.html references hashed assets, so new builds get new filenames

**Why This Matters:**
- Users get instant updates when index.html changes
- Hashed assets (JS/CSS) cached for 1 year = faster page loads
- CloudFront edge caching amplifies performance globally

### CloudFront Cache Invalidation

[Source: architecture/deployment-architecture.md#CI/CD Pipeline]

**Invalidation Strategy:**

After S3 sync completes, invalidate CloudFront cache:

```bash
aws cloudfront create-invalidation \
  --distribution-id $CLOUDFRONT_DISTRIBUTION_ID \
  --paths "/*"
```

**Invalidation Details:**
- `--paths "/*"` invalidates all cached content at CloudFront edge locations
- Invalidation takes **1-5 minutes** to propagate to all edge locations
- **First 1,000 invalidations per month are FREE**
- Additional invalidations: $0.005 per path (negligible cost)

**Why Invalidation is Required:**
- CloudFront caches content at edge locations globally
- Without invalidation, users may see stale content for hours/days
- Invalidation forces CloudFront to fetch fresh content from S3 origin

### GitHub Actions Workflow Configuration

[Source: architecture/deployment-architecture.md#CI/CD Pipeline]

**Workflow Triggers:**

```yaml
on:
  push:
    branches: [main]
  workflow_dispatch:
```

- **Push to main**: Automatic deployment on every commit to main branch
- **workflow_dispatch**: Manual trigger via GitHub UI (useful for hotfixes or rollbacks)

**Node.js Setup:**

```yaml
- name: Setup Node.js
  uses: actions/setup-node@v4
  with:
    node-version: '20'
    cache: 'npm'
```

- Uses Node.js 20.x LTS (matches tech stack requirement)
- `cache: 'npm'` caches node_modules for faster builds (30+ seconds saved per run)

**AWS Credentials Configuration:**

```yaml
- name: Configure AWS credentials
  uses: aws-actions/configure-aws-credentials@v4
  with:
    aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
    aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
    aws-region: us-east-1
```

- Configures AWS CLI with credentials from GitHub Secrets
- Region set to `us-east-1` (matches S3 bucket and CloudFront distribution)

### Project Structure

[Source: architecture/unified-project-structure.md]

**CI/CD File Locations:**

```
blade/ (root)
├── .github/
│   └── workflows/
│       ├── ci.yml                    # Run tests and linting (future)
│       └── deploy.yml                # Build and deploy to AWS (this story)
```

**New Files to Create:**
- `.github/workflows/deploy.yml` - Main CI/CD workflow file

**Files to Update:**
- `README.md` - Add deployment section and workflow status badge
- `docs/deployment-guide.md` - Create or update with detailed deployment instructions
- `infrastructure/aws-resources.md` - Add IAM user permissions documentation

### GitHub Secrets Configuration

**Required Secrets (to be added in GitHub repository settings):**

**AWS Credentials:**
- `AWS_ACCESS_KEY_ID` - IAM user access key ID
- `AWS_SECRET_ACCESS_KEY` - IAM user secret access key

**AWS Infrastructure IDs:**
- `S3_BUCKET` - S3 bucket name (value: `bladeandbarrel-site`)
- `CLOUDFRONT_DISTRIBUTION_ID` - CloudFront distribution ID (value: `EJNJPQN7X1JDD`)

**Frontend Environment Variables (placeholders for future stories):**
- `VITE_API_BASE_URL` - Backend API endpoint (placeholder: `https://api.bladeandbarrel.com`)
- `VITE_GA4_MEASUREMENT_ID` - Google Analytics 4 measurement ID (empty until Epic 3)
- `VITE_RECAPTCHA_SITE_KEY` - reCAPTCHA site key (empty until Epic 2)
- `VITE_INSTAGRAM_BUSINESS_ACCOUNT_ID` - Instagram Business Account ID (empty until Epic 3)

**Security Note:**
- Never commit secrets to repository (use GitHub Secrets)
- IAM user should have minimal required permissions (principle of least privilege)
- Rotate AWS access keys periodically for security

### Build Failure Handling

[Source: architecture/deployment-architecture.md#Deployment Process]

**Build Failure Prevention:**

GitHub Actions automatically fails workflow if any step returns non-zero exit code:

1. **TypeScript compilation errors** → `npm run build` fails → workflow stops
2. **Missing dependencies** → `npm ci` fails → workflow stops
3. **AWS CLI errors** → S3 sync or CloudFront invalidation fails → workflow stops

**Deployment Safety:**
- If build fails, S3 sync step never runs (previous deployment remains live)
- If S3 sync fails, CloudFront invalidation never runs (no partial deployment)
- GitHub Actions tab shows clear error logs for debugging

**Rollback Strategy:**

If bad deployment goes live:
1. **Option 1 (Quick)**: Revert commit and push to main (triggers new deployment)
2. **Option 2 (Manual)**: Use S3 versioning to restore previous deployment
3. **Option 3 (Immediate)**: Manually invalidate CloudFront and sync old files to S3

### File Locations

**New Files to Create:**
- `.github/workflows/deploy.yml` - GitHub Actions workflow for automated deployment

**Files to Modify:**
- `README.md` - Add deployment section with workflow status badge and setup instructions
- `docs/deployment-guide.md` - Create comprehensive deployment guide (or update if exists)
- `infrastructure/aws-resources.md` - Document IAM user permissions required for CI/CD

### Testing Requirements

[Source: architecture/testing-strategy.md]

**Infrastructure Testing (Workflow Validation):**

No automated tests required for CI/CD setup. Manual verification steps:

1. **Workflow Syntax Validation**:
   - GitHub Actions automatically validates YAML syntax on push
   - Workflow must pass syntax validation before execution

2. **Build Success Verification**:
   - Verify `npm run build` completes successfully
   - Verify no TypeScript compilation errors
   - Verify dist/ directory created with expected files

3. **Deployment Success Verification**:
   - Verify S3 sync completes (check S3 bucket contents in AWS console)
   - Verify CloudFront invalidation created (check CloudFront invalidations tab)
   - Verify changes visible at https://bladeandbarrel.com after invalidation completes

4. **Build Failure Test**:
   - Intentionally introduce TypeScript error
   - Push to main and verify workflow fails
   - Verify deployment does NOT occur (S3 unchanged)
   - Fix error and verify next deployment succeeds

**Future Test Integration (Epic 2+):**
- CI workflow (`.github/workflows/ci.yml`) will run tests before allowing merge
- Deployment workflow will only run if tests pass
- Integration tests will verify deployed site is functional

### Technical Constraints

**GitHub Actions Limitations:**
- Free tier: 2,000 minutes/month for private repos (public repos = unlimited)
- Workflow run timeout: 6 hours maximum (typical deployment: 2-5 minutes)
- Secrets stored encrypted at rest (secure storage)

**CloudFront Invalidation Constraints:**
- Invalidation propagation time: **1-5 minutes** (not instant)
- Free tier: **1,000 invalidations per month** (more than sufficient for typical usage)
- Invalidation limits: Max 3,000 paths per invalidation request

**S3 Sync Timing:**
- Small deployments (< 10 MB): **10-30 seconds**
- Typical deployment with assets: **30-60 seconds**
- Upload speed depends on file count and size

**Deployment Timing Breakdown:**
- Checkout + Node.js setup: ~20 seconds
- npm ci (with cache): ~30 seconds
- npm run build: ~20-40 seconds
- S3 sync: ~30-60 seconds
- CloudFront invalidation: ~1-5 minutes (async, doesn't block workflow)
- **Total workflow execution**: ~2-3 minutes
- **Time until changes live**: ~3-8 minutes (including invalidation)

### Cost Considerations

**GitHub Actions:**
- **Public repositories**: FREE unlimited build minutes
- **Private repositories**: FREE 2,000 minutes/month (sufficient for most projects)

**AWS CloudFront Invalidations:**
- **First 1,000 invalidations/month**: FREE
- **Additional invalidations**: $0.005 per path (negligible)
- **Estimated monthly cost**: $0 (well within free tier)

**Total CI/CD Cost Impact**: **$0/month** (assuming public repo or within private repo free tier)

---

## Testing

[Source: architecture/testing-strategy.md]

**Testing Framework:**
- **Infrastructure Tests**: Manual verification of CI/CD workflow (no automated tests for GitHub Actions setup)

**Test Organization:**
- No test files required for this infrastructure story
- Manual verification steps documented in Tasks

**Test Requirements for Story 1.4:**

1. **GitHub Repository Setup:**
   - Verify GitHub repository created and accessible
   - Verify all project files pushed to `main` branch
   - Verify `.gitignore` properly excludes node_modules, .env, dist

2. **Workflow File Validation:**
   - Verify `.github/workflows/deploy.yml` exists
   - Verify workflow YAML syntax is valid (GitHub validates automatically)
   - Verify workflow triggers on push to `main` branch
   - Verify `workflow_dispatch` allows manual triggering

3. **GitHub Secrets Configuration:**
   - Verify all required secrets added to repository settings
   - Verify AWS credentials (AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY)
   - Verify infrastructure IDs (S3_BUCKET, CLOUDFRONT_DISTRIBUTION_ID)
   - Verify environment variable placeholders added

4. **Build Process Verification:**
   - Push test commit to `main` branch
   - Monitor workflow execution in GitHub Actions tab
   - Verify all workflow steps complete successfully:
     - Checkout code ✓
     - Setup Node.js ✓
     - Install dependencies ✓
     - Build frontend ✓
     - Configure AWS credentials ✓
     - Sync to S3 ✓
     - Invalidate CloudFront cache ✓

5. **Deployment Verification:**
   - Wait for CloudFront invalidation to complete (1-5 minutes)
   - Navigate to https://bladeandbarrel.com
   - Verify changes from test commit are visible
   - Use browser DevTools to verify cache headers:
     - Assets (JS/CSS): `cache-control: public, max-age=31536000, immutable`
     - index.html: `cache-control: no-cache, no-store, must-revalidate`

6. **Build Failure Handling:**
   - Introduce intentional TypeScript error in code
   - Push to `main` branch
   - Verify workflow fails at build step
   - Verify S3 sync and CloudFront invalidation do NOT run
   - Verify GitHub Actions shows failure status with error logs
   - Fix error and push again
   - Verify workflow succeeds and deployment completes

7. **Documentation Verification:**
   - Verify README.md updated with deployment section
   - Verify workflow status badge added to README.md
   - Verify deployment guide created/updated in docs/
   - Verify IAM permissions documented in infrastructure/aws-resources.md

**Acceptance Criteria Test Coverage:**
- AC 1: Task 1 (GitHub repository creation and code push)
- AC 2: Task 2 (Workflow file creation)
- AC 3: Task 2, Task 3 (Workflow trigger configuration)
- AC 4: Task 3 (Install dependencies and build steps)
- AC 5: Task 4 (GitHub Secrets configuration)
- AC 6: Task 3 (S3 sync step)
- AC 7: Task 3 (CloudFront invalidation step)
- AC 8: Task 5 (Build failure handling)
- AC 9: Task 5 (Deployment status visibility)
- AC 10: Task 6 (End-to-end deployment test)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-08 | 1.0 | Initial story draft created | Bob (Scrum Master) |

---

## Dev Agent Record

### Agent Model Used

- **Model**: [To be filled by Dev Agent]
- **Date**: [To be filled by Dev Agent]

### Debug Log References

[To be filled by Dev Agent during implementation]

### Completion Notes

[To be filled by Dev Agent during implementation]

### File List

[To be filled by Dev Agent during implementation]

---

## QA Results

[To be filled by QA Agent after implementation]
